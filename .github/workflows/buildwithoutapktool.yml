name: Build LiteResources APK (manual build)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Install Android SDK + build tools
        run: |
          sudo mkdir -p /opt/android-sdk
          sudo chown $USER /opt/android-sdk
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip -d /opt/android-sdk
          yes | /opt/android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=/opt/android-sdk "platforms;android-33" "build-tools;33.0.2"
          echo "ANDROID_HOME=/opt/android-sdk" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_PATH

      - name: Install smali
        run: |
          sudo apt update
          sudo apt install -y zipalign apksigner aapt
          wget https://github.com/JesusFreke/smali/releases/latest/download/smali.jar -O smali.jar

      - name: Build classes.dex from smali
        run: |
          mkdir all_smali
          find lite_resources/smali_classes* -type d -exec cp -r {}/* all_smali/ \;
          java -jar smali.jar assemble all_smali -o classes.dex

      - name: Package resources + manifest + dex into unsigned APK
        run: |
          aapt package -f -M lite_resources/AndroidManifest.xml \
            -S lite_resources/res \
            -I $ANDROID_HOME/platforms/android-33/android.jar \
            -F unsigned.apk
          zip -j unsigned.apk classes.dex

      - name: Zipalign + sign APK
        run: |
          zipalign -p 4 unsigned.apk aligned.apk
          if [ -f mykey.keystore ]; then
            apksigner sign --ks-key-alias key --ks-pass pass:123456 --key-pass pass:123456 --ks mykey.keystore aligned.apk
          else
            echo "Keystore not found, skipping signing"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-apk
          path: aligned.apk
